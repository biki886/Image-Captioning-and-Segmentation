<!--
===============================================================================
Image Captioning and Segmentation System
===============================================================================

This project integrates two advanced computer vision tasks into a unified system:

1. **Image Captioning**  
   Uses a Transformer-based decoder model trained on COCO captions to generate
   natural-language descriptions of input images. The model processes extracted
   CNN features and sequentially predicts caption tokens based on a learned
   vocabulary.

2. **Semantic Segmentation + Object Detection**  
   Utilizes a Mask R-CNN (ResNet50 FPN) model to detect objects in an image,
   generate instance-level segmentation masks, and draw bounding boxes around
   top-scoring detections.

The goal of this system is to demonstrate how deep learning models can work
together to provide a richer understanding of visual dataâ€”combining pixel-level
segmentation, object identification, and high-level caption generation.

A FastAPI backend is used to run inference with both models, and a modern web
dashboard allows users to upload images and view results such as:
- Original image
- Segmentation mask
- Bounding box image
- Generated caption
- Top detected classes with confidence scores

This project is built for educational, research, and demonstration purposes.

-------------------------------------------------------------------------------
Author
-------------------------------------------------------------------------------
Name: **Supriya Mandal, Madana Venkatesh & Biki Haldar**  
GitHub: https://github.com/MSupriya4223  
Year: 2025  

If you use this code or extend it, please give proper credit to the author.
=============================================================================== 
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Captioning & Segmentation</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
.caption-box {
  font-size: 1.2rem;
  font-weight: 600;
  color: #ffdd57;
  text-shadow: 0 0 12px rgba(255,215,0,0.7);
  letter-spacing: .5px;
  padding: 8px 12px;
  border-left: 4px solid #ffdd57;
}

.placeholder {
  width: 100%;
  height: 260px;
  background: #2c2c2c;
  border: 2px dashed #555;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #777;
  font-size: 1.1rem;
  border-radius: 10px;
}

.card {
  background: #1a1a1a;
  padding: 14px;
  border-radius: 14px;
  border: 1px solid #333;
  box-shadow: 0 0 12px rgba(0,0,0,0.5);
}

#imageModal img {
  max-height: 92vh;
}
</style>
</head>

<body class="bg-black text-white p-6">

<!-- HEADER -->
<header class="text-center mb-8">
  <h1 class="text-4xl font-bold text-white">Image Captioning & Segmentation</h1>
  <p class="text-gray-400 mt-2">Upload an image to run segmentation and captioning model</p>
</header>

<!-- UPLOAD SECTION -->
<div class="flex flex-col items-center gap-4 mb-6">
  <input id="file" type="file"
    class="text-white bg-gray-900 border border-gray-700 p-3 rounded-xl w-80 cursor-pointer">
  
  <button id="run"
    class="px-6 py-2 bg-yellow-500 text-black font-semibold rounded-xl hover:bg-yellow-400 transition shadow-md">
    RUN ðŸ”¥
  </button>

  <p id="status" class="text-green-400 hidden"></p>
</div>

<!-- RESULT GRID -->
<div class="grid grid-cols-3 gap-6">

  <div class="card">
    <h2 class="text-xl font-semibold mb-2">Original</h2>
    <img id="orig" class="rounded-lg hidden cursor-zoom-in" onclick="openModal(this.src)">
    <div id="origPlaceholder" class="placeholder">No Image</div>
  </div>

  <div class="card">
    <h2 class="text-xl font-semibold mb-2">Mask</h2>
    <img id="mask" class="rounded-lg hidden cursor-zoom-in" onclick="openModal(this.src)">
    <div id="maskPlaceholder" class="placeholder">No Mask</div>
  </div>

  <div class="card">
    <h2 class="text-xl font-semibold mb-2">Boxes</h2>
    <img id="boxes" class="rounded-lg hidden cursor-zoom-in" onclick="openModal(this.src)">
    <div id="boxesPlaceholder" class="placeholder">No Boxes</div>
  </div>

</div>

<!-- CAPTION -->
<div class="mt-8 card">
  <h2 class="text-2xl font-bold mb-2">Caption</h2>
  <p id="caption" class="caption-box">No caption yet</p>
</div>

<!-- TOP CLASSES -->
<div class="mt-6 card">
  <h2 class="text-2xl font-bold mb-3">Top Predictions</h2>
  <div id="topclasses" class="space-y-1 text-gray-300"></div>
</div>

<!-- IMAGE MODAL -->
<div id="imageModal"
  class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">

  <img id="modalImage" class="rounded-lg shadow-xl border-2 border-gray-700">

</div>

<!-- FOOTER (3 names + GitHub links) -->
<footer class="text-center text-gray-500 mt-14 pt-6 border-t border-gray-800">
  <p class="text-sm">
    Â© 2025 Image Captioning & Segmentation â€¢ Developed by  
    <a href="https://github.com/biki886" target="_blank" class="text-yellow-400 font-semibold hover:underline">Biki</a> | 
    <a href="https://github.com/Msupriya4223" target="_blank" class="text-yellow-400 font-semibold hover:underline">Supriyo</a> | 
    <a href="https://github.com/Venkatesh-122" target="_blank" class="text-yellow-400 font-semibold hover:underline">Venkatesh</a>
  </p>
</footer>

<script>

const runBtn = document.getElementById("run");
const fileInput = document.getElementById("file");
const status = document.getElementById("status");

function updateImage(imgId, placeholderId, src) {
  const img = document.getElementById(imgId);
  const placeholder = document.getElementById(placeholderId);

  img.onerror = () => {
    img.style.display = "none";
    placeholder.style.display = "flex";
  };

  if (!src) {
    img.style.display = "none";
    placeholder.style.display = "flex";
  } else {
    img.src = src;
    img.style.display = "block";
    placeholder.style.display = "none";
  }
}

async function runModel() {
  if (!fileInput.files.length) {
    alert("Please upload an image first.");
    return;
  }

  const f = fileInput.files[0];
  const form = new FormData();
  form.append("file", f, f.name);

  status.innerText = "Processing...";
  status.classList.remove("hidden");

  try {
    const resp = await fetch("/predict", { method: "POST", body: form });
    const data = await resp.json();

    if (!resp.ok) {
      status.innerText = "Error: " + data.detail;
      return;
    }

    await fetch("/stage_tmp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tmpdir: data.tmpdir })
    });

    const ts = Date.now();

    updateImage("orig","origPlaceholder","/static/tmp/"+data.original+"?t="+ts);
    updateImage("mask","maskPlaceholder","/static/tmp/"+data.colored_mask+"?t="+ts);
    updateImage("boxes","boxesPlaceholder","/static/tmp/"+data.boxes+"?t="+ts);

    document.getElementById("caption").innerText = data.caption;

    const cls = document.getElementById("topclasses");
    cls.innerHTML = "";
    data.top_classes.forEach(c => {
      const div = document.createElement("div");
      div.textContent = `${c.label}: ${c.score.toFixed(4)}`;
      cls.appendChild(div);
    });

    status.innerText = "Done.";
    setTimeout(() => status.classList.add("hidden"), 2000);

  } catch (err) {
    console.error(err);
    status.innerText = "Failed: " + err;
  }
}

runBtn.onclick = runModel;

/* ENTER runs model */
document.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    runModel();
  }
});

/* OPEN MODAL */
function openModal(src) {
  const modal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");
  modalImage.src = src;
  modal.classList.remove("hidden");
}

/* CLOSE MODAL: click anywhere */
document.getElementById("imageModal").addEventListener("click", () => {
  document.getElementById("imageModal").classList.add("hidden");
});

/* ESC key also closes modal */
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    document.getElementById("imageModal").classList.add("hidden");
  }
});

</script>

</body>
</html>




